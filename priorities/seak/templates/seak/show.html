{% extends 'common/panel.html' %}
{% load humanize %}
{% load set_var %}
{% load percentage %}
{% load deslug %}
{% load flatblock_tags %}
{% block title %}{{instance.name}}{% endblock title %}
{% block panel %}

{% block progress %}
<input type="hidden" id="selected_progress_url" value="{% url analysis-progress instance.uid %}" />
{% if not instance.done %}
<div class="alert alert-info" 
     data-bind="visible: !done(), css: {'alert-error': error(), 'alert': !error()}">
    <div id="scenario_progress_html">
        <p data-bind="html: progressHtml"><!-- {{ instance.status_html|safe }} --></p>
    </div>
    <div class="progress progress-striped active" data-bind="visible: !error()">
        <div class="bar" data-bind="style: { width: progressBarWidth() }"></div>
    </div>
</div>
{% endif %}
{% endblock progress %}

{% if instance.expired %}
<div class="alert alert-error"> <i style="float:left; margin: 5px;" class="icon-exclamation-sign"></i> {% flatblock 'scenario-expired-message' 3600 %}</div>
{% endif %}

<div class="tabbable">
    <ul class="nav nav-tabs" style="margin-bottom:0px;">
        <li class="active"><a href="#Inputs" data-toggle="tab"><span>{% flatblock 'show-inputs' 3600 %}</span></a></li>
        {% if instance.done %}
            <li><a href="#species" data-toggle="tab"><span>{% flatblock 'show-conservation-features' 3600 %}</span></a></li>
            <li><a href="#watersheds" data-toggle="tab"><span>{% flatblock 'show-planning-units-tab' 3600 %}</span></a></li>
            {% if show_raw_costs %}
                <li><a href="#costs" data-toggle="tab"><span>{% flatblock 'show-total-costs' 3600 %}</span></a></li>
            {% endif %}
            {% if show_aux %}
                <li><a href="#aux" data-toggle="tab"><span>{% flatblock 'show-aux' 3600 %}</span></a></li>
            {% endif %}
        {% endif %}
    </ul>

    {% set results = instance.results %}
    <div class="tab-content tab-content-show">

        <div id="Inputs" class="tab-pane active">
            <div>
             <h4>{% flatblock 'targets' 3600 %}</h4>
             <table class="table">
             <thead> 
                <th>{% flatblock 'show-conservation-features' 3600 %}</th>
                {% if slider_mode == "single"%}
                    <th colspan="2"> {% flatblock 'relative-importance' 3600 %}</th>
                    <th class="debug-only">{% flatblock 'penalty' 3600 %}</th>
                {% elif slider_mode == "dual" %}
                    <th>{% flatblock 'target' 3600 %}</th>
                    <th>{% flatblock 'penalty' 3600 %}</th>
                {% endif %}
             </thead>
             <tbody>
                {% load multiply %}
                {% for k,v in results.targets_penalties.items %}
                <tr class="{% if v.target > 0 %}targeted{% else %}not-targeted{% endif %}"> 
                    <td>{{v.label}}</td>
                    {% if slider_mode == "single"%}
                        <td>
                            <div class="progress" style="width:120px; margin:0;">
                                <div class="bar" style="width:{{v.target|percentage}}"></div>
                            </div>
                        </td>
                        <td>{{v.target|percentage}}</td>
                        <td class="debug-only">{{v.penalty|percentage}}</td>
                    {% elif slider_mode == 'dual' %}
                        <td> 
                            <div class="row-fluid">
                                <span class="span6">
                                    <div class="progress" style="width:120px; margin:0;">
                                        <div class="bar" style="width:{{v.target|percentage}}"></div>
                                    </div> 
                                </span>
                                <span class="span6">{{v.target|percentage}}</span>
                            </div>
                        </td>
                        <td> 
                            <div class="row-fluid">
                                <span class="span6">
                                    <div class="progress" style="width:120px; margin:0;">
                                        <div class="bar" style="width:{{v.penalty|percentage}}"></div>
                                    </div> 
                                </span>
                                <span class="span6">{{v.penalty|percentage}}</span>
                            </div>
                        </td>
                    {% endif %}
                </tr>
                {% endfor %}
             </tbody>
             </table>

             <hr/>

            <h4>{% flatblock 'constraints' 3600 %}</h4>
             <table class="table">
             {%for k,v in results.costs.items %}
             {% if v > 0%}<tr><td> &#10003; {{k|deslug}}</td></tr> 
             {% else %}<tr class="debug-only"><td> &nbsp; <del>{{k}}</del></td></tr> 
             {% endif %} 
             {%endfor%}
             </table>
             
             <div class="debug-only">
                <h4>Scaling Factor</h4>
                <span>{{instance.input_scalefactor}}</span>
             </div>

            </div>
        </div>

        {% if instance.done %}

        <div id="watersheds" class="tab-pane">
            <div class="box">
                <p>{% flatblock 'optimal-prioritization-scenario' 3600 %} includes {{results.num_units}} {% flatblock 'show-planning-units' 3600 %} covering {{results.area|floatformat:0|intcomma}} {% flatblock 'area-units' 3600 %}. </p>

                <!-- IE < 10 does not like a tbody w height.  The workaround applies the scrolling to a wrapped <div>. -->
                <!--[if lte IE 9]>
                <div class="old_ie_wrapper">
                <!--<![endif]-->

                <table class="table pu-show">
                <thead class="pu-show">
                    <tr class="pu-show">
                    <th class="pu-show" scope="col"> {% flatblock 'show-planning-units' 3600 %} </th> 
                    {%for k,v in results.units.1.costs.items %}
                        {% if v > 0 %}
                        <th class="pu-show" scope="col">{{k|deslug}}</th>
                        {% endif %}
                    {%endfor%}
                    <tr>
                </thead>
                <tbody class="pu-show" id="best-pus">
                {% for w in results.units %}
                <tr id="purow-{{w.uid}}">
                    <td class="pu-show">{{w.name}}</td>

                    {% for k,v in w.costs.items %}
                    <td class="pu-show">
                        <span class="badge {% if v.class == 'low' %}badge-success{% elif v.class == 'med' %}badge-warning{% elif v.class == 'high' %}badge-important{% endif %}">
                            {{v.class}}{% if show_raw_costs %}: {{v.raw|floatformat:0|intcomma}}{% endif %}
                            {# v.scaled #}
                        </span>
                    </td>
                    {% endfor %}
                    <td class="centroid-x" style="display:none">{{w.centroidx}}</td>
                    <td class="centroid-y" style="display:none">{{w.centroidy}}</td>
                </tr>
                {% endfor %}
                </tbody>
                </table>

                <!--[if lte IE 9]>
                </div>
                <!--<![endif]-->

            </div>
             <script> 
                var best = $('tbody#best-pus');
                best.find('tr').click( function(e) { 
                    markers.clearMarkers();
                    $('tbody#best-pus tr').removeClass('highlighted-planningunit');
                    $(this).addClass('highlighted-planningunit');
                    var x = $(this).find('td.centroid-x').html();
                    var y = $(this).find('td.centroid-y').html();
                    var lonLat = new OpenLayers.LonLat(x,y);
                    markers.addMarker(new OpenLayers.Marker(lonLat));
                    map.setCenter([x,y]);
                });
             </script>
        </div>

        {% if show_raw_costs %}
        <div id="costs" class="tab-pane">
            <div class="box">
                <h5>  Total Costs </h5>
                <dl>
                    {% for k,v in results.total_costs.items %}
                    <dt>{{k|deslug}}</dt><dd>{{v|floatformat:0|intcomma}}</dd>
                    {% endfor %}
                </dl>
            </div>
        </div>
        {% endif %}

        {% if show_aux %}
        <div id="aux" class="tab-pane">
            <div class="box">
                <h5> {% flatblock 'show-aux' 3600 %} </h5>
                {% for w in results.units %}
                <div class="row-fluid">
                    <span class="span4"><strong>{{w.name}}</strong></span>
                    {% for k,v in w.auxs.items %}
                    <span class="badge"> {{k}}: {{v}} </span>
                    {% endfor %}
                </div>
                {% endfor %}

            </div>
        </div>
        {% endif %}

        <div id="species" class="tab-pane">
            <div class="box">
                <p>{% flatblock 'show-targets-explanation' 3600 %}</p>
                <p class="debug-only">Goals were met for {{results.num_met}} of {{results.num_species}} 
                        {% flatblock 'show-conservation-features' 3600 %}.</p>
                <table class="table" id="species_table" summary="Species Table">
                <thead>
                    <tr>
                        <th scope="col"> {% flatblock 'show-conservation-features' 3600 %} </th>
                        <th scope="col" colspan="2"> {% flatblock 'show-percent-met' 3600 %}</th>
                        <th class="debug-only" scope="col" width="80"> Goal Met?</th>
                    </tr>
                </thead>
                <tbody>
                {% for s in results.species %}
                <tr class="{% if s.target == 0 %}nogoal{% else %}hit{% endif %} {%if s.target_prop == 0%}not-targeted{%endif%}">
                    <td> <strong>{{s.level1}} > {{s.name}}</strong></td>
                    <td> <div class="progress" style="width:120px; margin:0;" ><div class="bar" style="width:{{s.pcttotal|percentage}}"></div></div></td>
                    {% if slider_show_raw %}
                    <td> {{s.held|floatformat:0|intcomma}} {{s.units}} ({{s.pcttotal|percentage:1}}) </td>
                    {% else %}
                    <td> {{s.pcttotal|percentage:1}} of total {{s.units}} </td>
                    {% endif %} 
                    <td class="debug-only"> {% if s.target == 0 %} - {% else %} 
                        {% if s.met %}&#10003;{% else %} NO<br/>(Goal was {{s.target_prop|percentage:0}}){% endif %} 
                         {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        </div>
    </div>

{% endblock panel %}
